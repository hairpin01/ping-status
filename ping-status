#!/usr/bin/env python3

import os
import sys
import subprocess
import configparser
import argparse
import urllib.request
import tempfile
import hashlib
import json
from pathlib import Path

__version__ = "2.2.0"
__author__ = "hairpin01"

# URLs –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
RAW_INSTALL = "https://raw.githubusercontent.com/hairpin01/ping-status/refs/heads/main/install.sh"
RAW_SCRIPT = "https://raw.githubusercontent.com/hairpin01/ping-status/refs/heads/main/ping-status"
RAW_CONFIG = "https://raw.githubusercontent.com/hairpin01/ping-status/refs/heads/main/ping_status.conf"
THEMES_BASE_URL = "https://raw.githubusercontent.com/hairpin01/ping-status/refs/heads/main/theme/"

# –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–º—ã
AVAILABLE_THEMES = {
    "minimal": "–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Ç–µ–º–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É",
    "detailed": "–ü–æ–¥—Ä–æ–±–Ω–∞—è —Ç–µ–º–∞ —Å —Ä–∞–º–∫–æ–π", 
    "modern": "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–µ–º–∞ —Å –∏–∫–æ–Ω–∫–∞–º–∏",
    "classic": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ç–µ–º–∞",
    "terminal": "–¢–µ–º–∞ –≤ —Å—Ç–∏–ª–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞"
}

def get_color_code(color):
    colors = {
        'black': '30',
        'red': '31',
        'green': '32',
        'yellow': '33',
        'blue': '34',
        'magenta': '35',
        'cyan': '36',
        'white': '37',
        'reset': '0'
    }
    return colors.get(color.lower(), '37')

def colorize(text, color):
    return f'\033[{get_color_code(color)}m{text}\033[0m'

def print_colored(text, color='white'):
    print(colorize(text, color))

def get_ping(host):
    try:
        result = subprocess.run(
            ['ping', '-c', '1', '-W', '1', host],
            capture_output=True,
            text=True,
            timeout=3
        )
        if result.returncode == 0:
            time_line = [line for line in result.stdout.split('\n') if 'time=' in line][0]
            ping_time = time_line.split('time=')[1].split(' ')[0]
            return ping_time
        return "unreachable"
    except:
        return "timeout"

def get_uptime():
    try:
        with open('/proc/uptime', 'r') as f:
            uptime_seconds = float(f.readline().split()[0])
        
        days = int(uptime_seconds // 86400)
        hours = int((uptime_seconds % 86400) // 3600)
        minutes = int((uptime_seconds % 3600) // 60)
        
        if days > 0:
            return f"{days}d {hours}h {minutes}m"
        elif hours > 0:
            return f"{hours}h {minutes}m"
        else:
            return f"{minutes}m"
    except:
        return "unknown"

def load_config():
    config_path = Path.home() / '.config' / 'ping-status.conf'
    
    if not config_path.exists():
        config_path = Path('/etc/ping-status.conf')
    
    config = configparser.ConfigParser()
    config.read(config_path)
    
    host = config.get('settings', 'host', fallback='google.com')
    template = config.get('settings', 'text', fallback='Ping: {ping}\nUptime: {uptime}\nUser: {user}\nHostname: {hostname}')
    
    ping_color = config.get('colors', 'ping', fallback='green')
    uptime_color = config.get('colors', 'uptime', fallback='yellow')
    user_color = config.get('colors', 'user', fallback='blue')
    hostname_color = config.get('colors', 'hostname', fallback='cyan')
    
    return {
        'host': host,
        'template': template,
        'colors': {
            'ping': ping_color,
            'uptime': uptime_color,
            'user': user_color,
            'hostname': hostname_color
        }
    }

def show_status():
    config = load_config()
    
    ping_value = get_ping(config['host'])
    uptime_value = get_uptime()
    user_value = os.getlogin()
    hostname_value = subprocess.run(['hostname'], capture_output=True, text=True).stdout.strip()
    
    output = config['template'].replace('{ping}', colorize(ping_value, config['colors']['ping']))
    output = output.replace('{uptime}', colorize(uptime_value, config['colors']['uptime']))
    output = output.replace('{user}', colorize(user_value, config['colors']['user']))
    output = output.replace('{hostname}', colorize(hostname_value, config['colors']['hostname']))
    
    print(output)

def download_file(url, dest_path):
    """–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –ø–æ URL"""
    try:
        with urllib.request.urlopen(url) as response:
            content = response.read()
            with open(dest_path, 'wb') as f:
                f.write(content)
        return True
    except Exception as e:
        print_colored(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {url}: {e}", 'red')
        return False

def get_remote_version():
    """–ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"""
    try:
        with urllib.request.urlopen(RAW_SCRIPT) as response:
            content = response.read().decode('utf-8')
            for line in content.split('\n'):
                if line.startswith('__version__'):
                    return line.split('=')[1].strip().strip("'\"")
    except:
        pass
    return None

def check_update():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"""
    print_colored("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...", 'yellow')
    
    remote_version = get_remote_version()
    if not remote_version:
        print_colored("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", 'red')
        return False
    
    print_colored(f"–õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: {__version__}", 'blue')
    print_colored(f"–£–¥–∞–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: {remote_version}", 'blue')
    
    if remote_version != __version__:
        print_colored("‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!", 'green')
        return True
    else:
        print_colored("‚úÖ –£ –≤–∞—Å –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è", 'green')
        return False

def perform_update():
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"""
    print_colored("üîÑ –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...", 'yellow')
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞
    if os.geteuid() != 0:
        print_colored("‚ùå –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ root. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å sudo.", 'red')
        return False
    
    # –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    with tempfile.TemporaryDirectory() as temp_dir:
        temp_script = os.path.join(temp_dir, 'ping-status')
        temp_config = os.path.join(temp_dir, 'ping-status.conf')
        
        # –°–∫–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
        print_colored("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞...", 'yellow')
        if not download_file(RAW_SCRIPT, temp_script):
            return False
        
        # –°–∫–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥
        print_colored("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞...", 'yellow')
        if not download_file(RAW_CONFIG, temp_config):
            return False
        
        # –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
        os.chmod(temp_script, 0o755)
        
        # –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
        print_colored("üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π...", 'yellow')
        backup_dir = Path('/tmp/ping-status-backup')
        backup_dir.mkdir(exist_ok=True)
        
        script_path = Path('/usr/local/bin/ping-status')
        config_path = Path('/etc/ping-status.conf')
        
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å copy2 –≤–º–µ—Å—Ç–æ rename –¥–ª—è –∫—Ä–æ—Å—Å-—Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
        import shutil
        
        if script_path.exists():
            shutil.copy2(str(script_path), str(backup_dir / 'ping-status.backup'))
        if config_path.exists():
            shutil.copy2(str(config_path), str(backup_dir / 'ping-status.conf.backup'))
        
        # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
        print_colored("‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤...", 'yellow')
        try:
            # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç
            shutil.copy2(temp_script, '/usr/local/bin/ping-status')
            os.chmod('/usr/local/bin/ping-status', 0o755)
            
            # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥
            shutil.copy2(temp_config, '/etc/ping-status.conf')
            
            # –û–±–Ω–æ–≤–∏—Ç—å —Å–∏–º–ª–∏–Ω–∫
            symlink_path = Path('/usr/local/bin/p')
            if symlink_path.exists():
                symlink_path.unlink()
            symlink_path.symlink_to('/usr/local/bin/ping-status')
            
            print_colored("‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!", 'green')
            print_colored(f"üìÅ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {backup_dir}", 'blue')
            return True
            
        except Exception as e:
            print_colored(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ: {e}", 'red')
            
            # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞
            print_colored("üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...", 'yellow')
            backup_script = backup_dir / 'ping-status.backup'
            backup_config = backup_dir / 'ping-status.conf.backup'
            
            try:
                if backup_script.exists():
                    shutil.copy2(str(backup_script), '/usr/local/bin/ping-status')
                    os.chmod('/usr/local/bin/ping-status', 0o755)
                if backup_config.exists():
                    shutil.copy2(str(backup_config), '/etc/ping-status.conf')
                
                print_colored("‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ", 'green')
            except Exception as restore_error:
                print_colored(f"‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: {restore_error}", 'red')
                print_colored("‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞", 'yellow')
            
            return False

def uninstall():
    """–£–¥–∞–ª–∏—Ç—å ping-status"""
    print_colored("üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ ping-status...", 'yellow')
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞
    if os.geteuid() != 0:
        print_colored("‚ùå –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ root. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å sudo.", 'red')
        return False
    
    files_to_remove = [
        '/usr/local/bin/ping-status',
        '/usr/local/bin/p',
        '/etc/ping-status.conf'
    ]
    
    user_config = Path.home() / '.config' / 'ping-status.conf'
    
    print_colored("–°–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:", 'red')
    for file in files_to_remove:
        if os.path.exists(file):
            print_colored(f"  - {file}", 'red')
    
    if user_config.exists():
        print_colored(f"  - {user_config} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ñ–∏–≥)", 'red')
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    try:
        confirm = input("\n–í—ã —É–≤–µ—Ä–µ–Ω—ã? (y/N): ").strip().lower()
        if confirm != 'y':
            print_colored("‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", 'yellow')
            return False
    except KeyboardInterrupt:
        print_colored("\n‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", 'yellow')
        return False
    
    # –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    removed_files = []
    for file in files_to_remove:
        try:
            if os.path.exists(file) or os.path.islink(file):
                if os.path.islink(file):
                    os.unlink(file)
                else:
                    os.remove(file)
                removed_files.append(file)
                print_colored(f"‚úÖ –£–¥–∞–ª–µ–Ω: {file}", 'green')
        except Exception as e:
            print_colored(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è {file}: {e}", 'red')
    
    # –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ñ–∏–≥
    if user_config.exists():
        try:
            remove_user_config = input(f"\n–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ñ–∏–≥ {user_config}? (y/N): ").strip().lower()
            if remove_user_config == 'y':
                user_config.unlink()
                print_colored(f"‚úÖ –£–¥–∞–ª–µ–Ω: {user_config}", 'green')
        except Exception as e:
            print_colored(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è {user_config}: {e}", 'red')
    
    print_colored(f"\n‚úÖ –£–¥–∞–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(removed_files)}", 'green')
    print_colored("üéØ –ü—Ä–æ–≥—Ä–∞–º–º–∞ —É–¥–∞–ª–µ–Ω–∞. –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫.", 'blue')
    return True

def show_version():
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏"""
    print_colored(f"Ping Status Monitor v{__version__}", 'cyan')
    print_colored(f"–ê–≤—Ç–æ—Ä: {__author__}", 'blue')
    print_colored("GitHub: https://github.com/hairpin01/ping-status", 'blue')

def list_themes():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–º"""
    print_colored("üé® –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–º—ã:", 'cyan')
    for theme, description in AVAILABLE_THEMES.items():
        print_colored(f"  {theme:12} - {description}", 'blue')
    print()
    print_colored("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ping-status --theme <–Ω–∞–∑–≤–∞–Ω–∏–µ_—Ç–µ–º—ã>", 'green')
    print_colored("–ò–ª–∏: ping-status --theme-url <URL_—Ç–µ–º—ã>", 'green')

def apply_theme(theme_name):
    """–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É –ø–æ –∏–º–µ–Ω–∏"""
    if theme_name not in AVAILABLE_THEMES:
        print_colored(f"‚ùå –¢–µ–º–∞ '{theme_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", 'red')
        print_colored("–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–º—ã:", 'yellow')
        list_themes()
        return False
    
    theme_url = f"{THEMES_BASE_URL}{theme_name}.conf"
    return apply_theme_from_url(theme_url, theme_name)

def apply_theme_from_url(theme_url, theme_name="custom"):
    """–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É –∏–∑ URL"""
    print_colored(f"üé® –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã '{theme_name}'...", 'yellow')
    
    try:
        # –°–∫–∞—á–∞—Ç—å —Ç–µ–º—É
        with urllib.request.urlopen(theme_url) as response:
            theme_content = response.read().decode('utf-8')
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ñ–∏–≥
        user_config_path = Path.home() / '.config' / 'ping-status.conf'
        user_config_path.parent.mkdir(exist_ok=True)
        
        # –°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
        if user_config_path.exists():
            backup_path = user_config_path.with_suffix('.conf.backup')
            user_config_path.rename(backup_path)
            print_colored(f"üíæ –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø: {backup_path}", 'blue')
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—É—é —Ç–µ–º—É
        with open(user_config_path, 'w') as f:
            f.write(theme_content)
        
        print_colored(f"‚úÖ –¢–µ–º–∞ '{theme_name}' —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!", 'green')
        return True
        
    except Exception as e:
        print_colored(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã: {e}", 'red')
        return False

def main():
    parser = argparse.ArgumentParser(description='Ping Status Monitor')
    parser.add_argument('--version', '-v', action='store_true', help='–ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é')
    parser.add_argument('--check-update', action='store_true', help='–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è')
    parser.add_argument('--update', action='store_true', help='–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É')
    parser.add_argument('--uninstall', action='store_true', help='–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É')
    parser.add_argument('--list-themes', action='store_true', help='–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ–º')
    parser.add_argument('--theme', help='–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É –ø–æ –∏–º–µ–Ω–∏')
    parser.add_argument('--theme-url', help='–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É –∏–∑ URL')
    
    args = parser.parse_args()
    
    if args.version:
        show_version()
    elif args.check_update:
        check_update()
    elif args.update:
        perform_update()
    elif args.uninstall:
        uninstall()
    elif args.list_themes:
        list_themes()
    elif args.theme:
        apply_theme(args.theme)
    elif args.theme_url:
        apply_theme_from_url(args.theme_url, "custom")
    else:
        show_status()

if __name__ == '__main__':
    main()
